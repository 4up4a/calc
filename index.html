<!DOCTYPE html>
<html>
<head>
    <title>JSONBin Auth</title>
</head>
<body>
    <h2>Вход в систему</h2>
    <input id="loginInput" type="text" placeholder="Логин">
    <input id="passInput" type="password" placeholder="Пароль">
    <button onclick="loginUser()">Войти</button>

    <script>
        const BIN_ID = '67e3e5f28a456b79667d084e';
        const API_KEY = '$2a$10$0rbZvcFhC8Rmuo7YVKD/I.VakCon/XSZCRUwhmaSrROlz6s2QI.dK';

        async function fetchBin() {
            const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                headers: { "X-Master-Key": API_KEY }
            });
            return await response.json();
        }

        async function updateBin(data) {
            await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                method: "PUT",
                headers: { "X-Master-Key": API_KEY, "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
        }

        async function login(login, password) {
            try {
                const bin = await fetchBin();
                
                // Проверяем существует ли record и users
                if (!bin.record || !bin.record.users) {
                    alert("Ошибка структуры данных!");
                    return false;
                }

                const user = bin.record.users.find(u => u.login === login);
                
                if (!user) {
                    alert("Пользователь не найден!");
                    return false;
                }

                if (user.password !== password) {
                    alert("Неверный пароль!");
                    return false;
                }
                if (user.isAdmin) {
                    window.location.href = 'pages/adminpanel.html';
                }else{
                    window.location.href= 'pages/calcpage.html';
                }
                localStorage.setItem("currentUser", JSON.stringify(user));
                alert("Вход выполнен!");
                return true;
            } catch (error) {
                console.error("Ошибка:", error);
                alert("Произошла ошибка при входе");
                return false;
            }
        }

        async function loginUser() {
            const log = document.getElementById('loginInput').value;
            const password = document.getElementById('passInput').value;
            
            if (!log || !password) {
                alert("Введите логин и пароль!");
                return;
            }

            await login(log, password);
        }
    </script>
</body>
</html>